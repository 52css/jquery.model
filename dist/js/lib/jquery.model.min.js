/**
 * Created by kerr on 2015/4/20.
 * Version: 0.0.1
 */define(function(t,e,a){var i=t("./jquery"),n=t("./fastclick"),o=t("./iscroll");t("./jquery.dim"),n.attach(document.body),document.addEventListener("touchmove",function(t){t.preventDefault()},!1),i.dim("left",function(t,e,a){var n=this,o=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t};a.exports=o({data:{show:!1},isShow:function(){var t=a.exports;return t.data.show},show:function(){var t=a.exports;t.data.show=!0},hide:function(){var t=a.exports;t.data.show=!1}})}),i.dim("right",function(t,e,a){var n=this,o=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t};a.exports=o({data:{show:!1},isShow:function(){var t=a.exports;return t.data.show},show:function(){var t=a.exports;t.data.show=!0},hide:function(){var t=a.exports;t.data.show=!1}})}),i.dim("top",function(t,e,a){var n=this,o=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t};a.exports=o({data:{show:!1,content:"this is top"},isShow:function(){var t=a.exports;return t.data.show},show:function(t){var e=a.exports;e.data.content=t,e.data.show=!0},hide:function(){var t=a.exports;t.data.show=!1}})}),i.dim("bottom",function(t,e,a){var n=this,o=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t};a.exports=o({data:{show:!1,content:""},isShow:function(){var t=a.exports;return t.data.show},show:function(t){var e=a.exports;e.data.content=t,e.data.show=!0},hide:function(){var t=a.exports;t.data.show=!1}},{close:function(){i(this).on("click",".close-bottom",function(){var t=a.exports;t.hide()})}})}),i.dim("mask",function(t,e,a){var n=this,o=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t};a.exports=o({data:{show:!1,black:!0},isShow:function(){var t=a.exports;return t.data.show},showBlack:function(){var t=a.exports;t.data.black=!0,t.data.show=!0},showWhite:function(){var t=a.exports;t.data.black=!1,t.data.show=!0},hide:function(){var t=a.exports;t.data.show=!1}})}),i.dim("indicator",["mask"],function(t,e,a){var n=this,o=t("mask"),s=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t};a.exports=s({data:{show:!1},isShow:function(){var t=a.exports;return t.data.show},show:function(){var t=a.exports;o.showWhite(),t.data.show=!0},hide:function(){var t=a.exports;o.hide(),t.data.show=!1}})}),i.dim("modal",["mask"],function(t,e,a){var n=this,o=t("mask"),s=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t},r=function(t,e,n,s,r){var c,h,l=a.exports;l.data.push({show:!1,title:e,content:t,btn:n}),o.showBlack(),c=i(".alert:first"),h=i(".alert:eq("+(l.data.length-1)+")"),s&&h.find(".btn:last").on("click",s),r&&h.find(".btn:first").on("click",r),l.data[0].show||(l.data[0].show=!0,c.show(),setTimeout(function(){c.find(".alert-in").addClass("open-alert")},0))};a.exports=s({data:[],confirm:function(t,e,a,i){r(t,e,[{text:"Cancel"},{text:"Ok"}],a,i)},alert:function(t,e,a){r(t,e,[{text:"Ok"}],a)},preloader:function(t){r('<i class="fa fa-spinner fa-pulse fa-2x"></i>',t||"Loading...",[])},preloader2:function(t){r('333<i class="fa fa-spinner fa-pulse fa-2x"></i>',t||"Loading...",[])},isShow:function(){var t=a.exports;return t.data.length},hide:function(){var t=a.exports,e=i(".alert:eq(1)").show();i(".alert:first .alert-in").removeClass("open-alert").addClass("close-alert").on("transitionend webkitTransitionEnd",function(){t.data.shift(),t.data.length||o.hide()}),setTimeout(function(){e.find(".alert-in").addClass("open-alert")},0)},hideAll:function(){var t=a.exports;t.data.clear()}},{closeBtn:function(){i(this).on("click",".btn",function(){var t=a.exports;t.hide()})}})}),i.dim("bottomBtn",["mask"],function(t,e,a){var n=this,o=t("mask"),s=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t};a.exports=s({data:{show:!1,list:[]},isShow:function(){var t=a.exports;return t.data.show},show:function(t){var e=a.exports;e.data.list=t,o.showBlack(),e.data.show=!0},hide:function(){var t=a.exports;o.hide(),t.data.show=!1}},{close:function(){i(this).on("click",function(t){var e=a.exports,n=i(t.target),o=n.closest(".btn"),s=n.hasClass("bottom-btn");(o.length||s)&&e.hide()})}})}),i.dim("router",["indicator","left","right","bottomBtn"],function(t,e,a){var n=this,s=(t("indicator"),t("left")),r=t("right"),c=t("bottomBtn"),h=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t},l={pages:{main:[],left:[],right:[]},events:{ajaxRender:[],pageFirstInit:[],pageInit:[],pageBeforeAnimate:[],pageAfterAnimate:[],pageOut:[]},history:[],visitor:[],index:-1,areaClassName:"main",viewClassName:"view",pageClassName:"page",pageAnimateClassName:"slide",on:function(t,e,a){var i=arguments;2===i.length&&(a=e,e=null);var n=t.split("."),o=n[0],s=n[1];return l.events[o].push({key:s,pageName:e,callback:a}),l},off:function(t){var e=t.split("."),a=e[0],i=e[1];if(a)l.events[a]=i?l.events[a].map2(function(t){return t.key===i?null:void 0}):[];else if(i)for(var n in l.events)l.events[n]=l.events[n].forEach(function(t){return t.key===i?null:void 0});return app},getState:function(t){var e,a,i={query:{}};return t=t||location.hash,/^#!\//.test(t)?(i.isUrl=!0,i.url=t,t=t.slice(3),e=t.split("?"),e[0]&&(i.pageId=e[0],i.href=i.pageId+".html"+(e[1]?"?"+e[1]:"")),e[1]&&(a=e[1].split("#"),a[0].replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(t,e,a,n){i.query[e]=unescape(n)}),a[1]&&(i.anchor=e[1]))):/^[\w -]+\.html/.test(t)?(i.isUrl=!0,i.href=t,e=t.split("?"),e[0]&&(i.pageId=e[0].split(".").slice(0,-1).join("."),i.url="#!/"+i.pageId+(e[1]?"?"+e[1]:"")),e[1]&&(a=e[1].split("#"),a[0].replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(t,e,a,n){i.query[e]=unescape(n)}),a[1]&&(i.anchor=e[1]))):i.isUrl=!1,i},getArea:function(){var t=this;return window.routerIndex>=0?t.history[window.routerIndex].area:t.areaClassName},getAreaByPageId:function(t){var e,a=this;return i.each(a.pages,function(a,n){return i.each(n,function(i,n){return n.id===t?(e=a,!1):void 0}),e?!1:void 0}),e},getAreaIndex:function(t){var e=-1;return i.each(l.history,function(a,i){return i.pageId===t?(e=a,!1):void 0}),e},switchPage:function(t){var e,a,n,o,c,h,l=this,d=t.url,u=t.pageId,f=l.getAreaIndex(u),p=i("#"+u),v=p[0],w=l.history[window.routerIndex];if(w){if(a=w.pageId,c=l.getAreaIndex(a),n=i("#"+a),o=n[0],i.each(l.events.pageOut,function(e,a){(a.pageName===formPageId||void 0===a.pageName||null===a.pageName)&&a.callback(o,t)}),w.area===t.area)n.css("visibility","visible").addClass("out").addClass(l.getPageAnimateClassName(o)).removeClass("in"),p.css("visibility","visible").removeClass("out").addClass(l.getPageAnimateClassName(v)).addClass("in"),c>f&&f>=0?(n.addClass("reverse"),p.addClass("reverse")):(n.removeClass("reverse"),p.removeClass("reverse"));else switch(t.area){case"left":p.css("visibility","visible").removeClass("out").addClass("in"),s.show();break;case"right":p.css("visibility","visible").removeClass("out").addClass("in"),r.show();break;case"main":switch(w.area){case"left":n.removeClass("in").addClass("out"),s.hide(),p.css("visibility","visible").removeClass("out").addClass("in").siblings().css("visibility","hidden").removeClass("in").addClass("out");break;case"right":n.removeClass("in").addClass("out"),r.hide()}}i.each(l.visitor,function(e,a){return a.pageId==t.pageId?(h=!0,!1):void 0})}else p.css("visibility","visible").removeClass("out").addClass("in");h||i.each(l.events.pageFirstInit,function(e,a){(a.pageName===u||void 0===a.pageName||null===a.pageName)&&a.callback(v,t)}),i.each(l.events.pageInit,function(e,a){(a.pageName===u||void 0===a.pageName||null===a.pageName)&&a.callback(v,t)}),e=t.title=p.attr("data-title")||document.title,document.title=e,t.time=new Date,l.visitor.push(t);var g;i.each(l.history,function(e,a){return a.pageId===t.pageId&&i.param(a.query)===i.param(t.query)?(g=e,!1):void 0}),g>=0?window.routerIndex=f:w?(l.history=l.history.slice(0,window.routerIndex+1),l.history.push(t),window.routerIndex=l.history.length-1,history.pushState(t,e,d)):(l.history.push(t),window.routerIndex=l.history.length-1,history.replaceState(t,e,d))},loadPage:function(t,e){var a,n,o=this,s=o.getArea();i.ajax({url:t,success:function(t){n=i(t).appendTo(i("."+s+" ."+o.viewClassName))[0],o.pages[s].push(n)},error:function(){a="请求超时，请重试。"},complete:function(){e(a,n)}})},go:function(t){var e,a,n,o=this,s=o.getArea(),r=o.getState(t),c=-1;r.isUrl?(i.each(o.history,function(t,e){return e.pageId===r.pageId&&i.param(e.query)===i.param(r.query)?(c=t,!1):void 0}),c>=0?history.go(c-window.routerIndex):(n=r.pageId,e=o.getAreaByPageId(n),e?(r.area=e,o.switchPage(r)):(r.area=s,o.loadPage(r.href,function(t,e){return t?!1:void o.switchPage(r)})))):(a=o.pages[s][0],n=a.id,r=o.getState("#!/"+n),r.area=s,o.switchPage(r))},back:function(){history.back()},getPageAnimateClassName:function(t){var e=this;return i(t).attr("data-animate")||e.pageAnimateClassName},pageBindEvent:function(t){var e=this;i(t).on("webkitAnimationEnd",function(){var t=this,a=t.id,n=i(t),o=e.getPageAnimateClassName(t);n.removeClass(o),n.hasClass("in")?i.each(e.events.pageAfterAnimate,function(e,i){(i.pageName===a||void 0===i.pageName||null===i.pageName)&&i.callback(t)}):n.css("visibility","hidden")}).on("webkitAnimationStart",function(){var t=this,a=t.id,n=i(t);n.hasClass("in")&&i.each(e.events.pageBeforeAnimate,function(e,i){(i.pageName===a||void 0===i.pageName||null===i.pageName)&&i.callback(t)})})},fillPages:function(){var t=this;i(".main").on("webkitAnimationEnd",function(){}),i.each(t.pages,function(e,a){i("."+e+" ."+t.pageClassName).each(function(){t.pageBindEvent(this,e),a.push(this)})})},init:function(){l.fillPages(),l.go()}};l.on("pageFirstInit",function(t){new o(i(t).find(".wrapper")[0],{mouseWheel:!0})}),a.exports=h(l,{aClick:function(){i(document).on("click","a",function(){var t=i(this),e=t.attr("href"),a=t.attr("data-rel");return e&&(/^#!\//.test(e)||/^[\w -]+\.html/.test(e))&&"external"!==a?(l.go(e),!1):void 0})},popstate:function(){window.addEventListener("popstate",function(t){l.switchPage(t.state)})},mainClick:function(){i(document).on("click",function(t){var e=t.target,a=i(e).closest(".main"),n=-1;if(a&&a.length){if(s.isShow())for(var o=l.visitor.length-2;o>=0;o--){if("left"!==l.visitor[o].area){history.go(n);break}n--}if(r.isShow())for(var o=l.visitor.length-2;o>=0;o--){if("right"!==l.visitor[o].area){history.go(n);break}n--}c.isShow()&&c.hide()}})}})}),i.dim("app",["top","bottom","left","right","modal","indicator","bottomBtn","router"],function(t,e,a){var n=this,o=t("top"),s=t("bottom"),r=t("left"),c=t("right"),h=t("modal"),l=t("indicator"),d=t("bottomBtn"),u=t("router"),f=function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t};a.exports=f({isShowLeft:r.isShow,showLeft:r.show,hideLeft:r.hide,isShowRight:c.isShow,showRight:c.show,hideRight:c.hide,isShowTop:o.isShow,showTop:o.show,hideTop:o.hide,isShowBottom:s.isShow,showBottom:s.show,hideBottom:s.hide,isShowIndicator:l.isShow,showIndicator:l.show,hideIndicator:l.hide,isShowModal:h.isShow,alert:h.alert,confirm:h.confirm,showPreloader:h.preloader,hidePreloader:h.hide,showPreloader2:h.preloader2,isShowBottomBtn:d.isShow,showBottomBtn:d.show,hideBottomBtn:d.hide,on:u.on,off:u.off,go:u.go,back:u.back,init:u.init,getState:u.getState},{backbutton:function(){i(document).on("backbutton",function(){return o.isShow()?(o.hide(),!1):s.isShow()?(s.hide(),!1):h.isShow()?(h.hideAll(),!1):d.isShow()?(d.hide(),!1):void 0})}})}),i.dim("app-fn",["app"],function(t,e,a){var n=this,o=(t("app"),function(t,e){return e&&i.each(e,function(e,a){a&&a.call(n,t)}),t});a.exports=o({},{tab:function(){i(document).on("click","a",function(){var t=i(this),e=t.attr("href");return/^#\w+/.test(e)?(t.addClass("active").siblings().removeClass("active"),i(e).css({visibility:"visible",display:"block"}).siblings().css({visibility:"hidden",display:"none"}),!1):void 0})}})})});